#!/usr/bin/env sh

MODE=$1

FILES=$(ls spec/**/*.spec.*)

if [ "$MODE" = "fast" ]; then
  bin/steroids __banner fast --color green
elif [ "$MODE" == "release" ]; then
  bin/steroids __banner release --color yellow

  echo "\nTo ensure clean node_modules in everywhere, we'll uninstall everything else than 'npm' from $GLOBAL_NODE_MODULES"
  echo "ok? (Y/n)"

  read UNINSTALL_GLOBAL_OK

  if [ "$UNINSTALL_GLOBAL_OK" != "n" ]; then
    echo "deleting other than 'npm' from global.."
    npm ls -gp | awk -F/ '/node_modules/&&!/node_modules.*node_modules/&&!/npm/{print $NF}' | xargs npm rm -g
    echo "clearing cache"
    npm cache clear -g
  else
    echo "not uninstalling"
  fi

  echo "\nThen deleting everything from: ./node_modules"
  echo "ok? (Y/n)"

  read DELETE_LOCAL_OK

  if [ "$DELETE_LOCAL_OK" != "n" ]; then
    echo "deleting local.."
    rm -rf ./node_modules
  else
    echo "not deleting"
  fi

  echo "Now running: $ npm install --force"
  echo "ok? (Y/n)"

  read INSTALL_OK

  if [ "$INSTALL_OK" != "n" ]; then
    npm install --force
  else
    echo "not installing"
  fi


  echo "Now running: $ rm -rf __testApp && devroids create __testApp"

  echo "ok? (Y/n)"

  read BASE_APP_OK

  if [ "$BASE_APP_OK" != "n" ]; then
    rm -rf __testApp && devroids create __testApp
  else
    echo "not creating"
  fi

elif [ "$MODE" != "" ]; then
  bin/steroids __banner single --color cyan
  FILES=$1
  MODE=single
else
  MODE=full
fi


if [ ! -d "__testApp" ]; then
  echo "__testApp does not exists, create with bin/test"
  exit 1
fi



ERRORS=false

for FILE in $FILES; do
  echo "Running $FILE"

  STEROIDS_TEST_RUN=true STEROIDS_TEST_RUN_MODE=$MODE node_modules/jasmine-node/bin/jasmine-node --verbose --coffee --color $FILE
  if [ "$?" != 0 ]; then
    ERRORS=true
  fi

  echo "done with $FILE"
done

echo "\n\n"
if [ "$ERRORS" = true ]; then

  bin/steroids __banner "ERRORS" --color bgRed

  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  echo "  TEST RUN HAD ERRORS"
  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  exit 1
else
  bin/steroids __banner "BUMAYE" --color bgGreen
  echo "good to go!"
fi
